<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ICE Detention Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link rel="stylesheet" href="css/styles.css" />
    <script
      defer
      data-domain="watchice.org"
      src="https://plausible.io/js/script.outbound-links.js"
    ></script>
  </head>
  <body>
    <header>
      <nav id="header-bar">
        <div id="header-left">
          <div id="header-title">ICE Detention Map</div>
        </div>
        <div id="header-stats"><span><strong>{{ total_people }}</strong> people in ICE detention</span><span><strong>{{ pct_noncriminal }}</strong> without criminal records</span></div>
        <div id="header-nav">
          <a href="index.html" class="active">Map</a>
          <a href="info.html">Info</a>
          <a
            id="donate-link"
            href="https://opencollective.com/lockdown-systems"
            target="_blank"
            rel="noopener"
          >Donate</a>
        </div>
      </nav>
    </header>
    <main>
      <div id="map"></div>
      <button id="legend-toggle" onclick="toggleLegend()">Show Legend</button>
      <div class="legend" id="legend-box">
        <div style="font-weight: 600; margin-bottom: 0.5em">Legend</div>
        <div class="legend-row">
          <span
            class="legend-icon"
            style="background: rgba(76, 175, 80, 0.7); width: 12px; height: 12px; border-radius: 50%; border: 2px solid #222"
          ></span><span class="legend-label">&lt; 50 people</span>
        </div>
        <div class="legend-row">
          <span
            class="legend-icon"
            style="background: rgba(255, 235, 59, 0.7); width: 18px; height: 18px; border-radius: 50%; border: 2px solid #222"
          ></span><span class="legend-label">50–199 people</span>
        </div>
        <div class="legend-row">
          <span
            class="legend-icon"
            style="background: rgba(255, 152, 0, 0.7); width: 24px; height: 24px; border-radius: 50%; border: 2px solid #222"
          ></span><span class="legend-label">200–499 people</span>
        </div>
        <div class="legend-row">
          <span
            class="legend-icon"
            style="background: rgba(244, 67, 54, 0.7); width: 30px; height: 30px; border-radius: 50%; border: 2px solid #222"
          ></span><span class="legend-label">500+ people</span>
        </div>
      </div>
    </main>
    <div id="last-updated">
      last checked: {{ formatted_date }} | last updated: {{ extraction_date }}
    </div>
    <a
      id="logo-link"
      href="https://lockdown.systems/"
      target="_blank"
      rel="noopener"
    >
      <img id="footer-logo" src="img/logo-wide.svg" alt="Lockdown Systems" />
    </a>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      const [center_lat, center_lon] = [39.8283, -98.5795];

      var map = L.map("map").setView([center_lat, center_lon], 4);
      L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          maxZoom: 18,
          attribution: "© OpenStreetMap contributors",
        },
      ).addTo(map);

      // Legend toggle for mobile
      function toggleLegend() {
        var legend = document.getElementById("legend-box");
        var btn = document.getElementById("legend-toggle");
        if (legend.style.display === "none") {
          legend.style.display = "";
          btn.textContent = "Hide Legend";
          btn.style.bottom = "100px";
          btn.style.left = "auto";
          btn.style.right = "30px"; // Position button to the right of legend
        } else {
          legend.style.display = "none";
          btn.textContent = "Show Legend";
          btn.style.bottom = "30px";
          btn.style.left = "20px";
          btn.style.right = "auto"; // Return to original left position
        }
      }
      // On load, hide legend and show toggle on mobile
      if (window.innerWidth <= 700) {
        document.getElementById("legend-box").style.display = "none";
        document.getElementById("legend-toggle").textContent = "Show Legend";
      }
      window.addEventListener("resize", function () {
        if (window.innerWidth <= 700) {
          document.getElementById("legend-toggle").style.display = "block";
          document.getElementById("legend-box").style.display = "none";
          document.getElementById("legend-toggle").textContent = "Show Legend";
        } else {
          document.getElementById("legend-toggle").style.display = "none";
          document.getElementById("legend-box").style.display = "";
        }
      });

      class Facility {
        constructor(facility) {
          this.name = facility.name;
          this.addr = facility.addr;
          this.city = facility.city;
          this.state = facility.state;
          this.zipc = facility.zipc;
          this.lat = facility.lat;
          this.lon = facility.lon;
          this.criminals = facility.criminals;
          this.noncriminals = facility.noncriminals;
          this.threatLevels = facility.threatLevels;
          this.total = this.criminals + this.noncriminals;
          this.pct_criminal = this.total > 0
            ? `${
              Math.round(
                100 * (this.criminals / (this.noncriminals + this.criminals)),
              )
            }%`
            : "N/A";
          const [color, size] = this.getMarkerStyle();
          this.color = color;
          this.size = size;
          this.marker = this.makeMarker();
          this.addToMap();
        }

        getMarkerStyle() {
          // Green
          if (this.total < 50) {
            return ["rgba(76,175,80,0.7)", 12];
          }

          // Yellow
          if (this.total < 200) {
            return ["rgba(255,235,59,0.7)", 18];
          }

          // Orange
          if (this.total < 500) {
            return ["rgba(255,152,0,0.7)", 24];
          }

          // Red
          return ["rgba(244,67,54,0.7)", 30];
        }

        makePopup() {
          const lines = [
            `<b>${this.name}</b>`,
            `${this.addr}, ${this.city}, ${this.state} ${this.zipc}`,
            `Criminals: <b>${this.criminals}</b>`,
            `Non-Criminals: <b>${this.noncriminals}</b>`,
            `Percentage Criminal: <b>${this.pct_criminal}</b>`,
          ];
          const threatLevels = [
            ["ICE Threat Level 1", this.threatLevels[1]],
            ["ICE Threat Level 2", this.threatLevels[2]],
            ["ICE Threat Level 3", this.threatLevels[3]],
            ["No ICE Threat Level", this.threatLevels[0]],
          ];
          if (threatLevels.some(([_, val]) => val != null)) {
            lines.push(
              '<hr style="margin:0.3em 0;">',
              "<b>ICE Threat Level Breakdown</b>",
            );
            for (const [label, val] of threatLevels) {
              if (val != null) {
                lines.push(`${label}: <b>${val}</b>`);
              }
            }
          }
          return lines.join("<br/>");
        }

        makeHtml() {
          return `<span style=\"display:inline-block;width:${this.size}px;height:${this.size}px;background:${this.color};opacity:0.7;border:2px solid #222;border-radius:50%;box-shadow:0 1px 4px rgba(0,0,0,0.12);\"></span>`;
        }

        makeMarker() {
          if (this.lat == null || this.lon == null) {
            return null;
          }
          return L.marker([this.lat, this.lon], {
            icon: L.divIcon({
              className: "customMarker",
              html: this.makeHtml(),
            }),
          });
        }

        addToMap() {
          if (this.marker != null) {
            this.marker.addTo(map).bindPopup(this.makePopup());
          }
        }
      }

      const facilities = [
        {% for facility in facilities %}
          new Facility({{ facility | safe }}),
        {% endfor %}
      ];

      function facilitiesInView(facs) {
        return facs.filter((fac) =>
          fac.marker != null &&
          map.getBounds().contains(fac.marker.getLatLng())
        );
      }

      function calculateTotalCriminal(facs) {
        return facs.filter((fac) => fac.criminals != null).reduce(
          (total, fac) => total + fac.criminals,
          0,
        );
      }

      function calculateTotalNoncriminal(facs) {
        return facs.filter((fac) => fac.criminals != null).reduce(
          (total, fac) => total + fac.noncriminals,
          0,
        );
      }

      function calculatePctNoncriminal(
        totalCriminal,
        totalNoncriminal,
      ) {
        const total = totalCriminal + totalNoncriminal;
        if (total == 0) {
          return "N/A";
        }
        const pctNoncriminal = Math.round(
          100 * (totalNoncriminal / total),
        );
        return `${pctNoncriminal}%`;
      }

      function calculateHeaderStats(facs, e) {
        const totalCriminal = calculateTotalCriminal(facs);
        const totalNoncriminal = calculateTotalNoncriminal(facs);
        const pctNoncriminal = calculatePctNoncriminal(
          totalCriminal,
          totalNoncriminal,
        );

        const [total, percentage] = document.getElementById("header-stats").childNodes;
        total.innerHTML = `<strong>${totalCriminal + totalNoncriminal}</strong> people in ICE detention`;
        percentage.innerHTML = `<strong>${pctNoncriminal}</strong> without criminal records`;
      }

      function calculateInViewStats(e) {
        const visibleFacilities = facilitiesInView(facilities);
        calculateHeaderStats(visibleFacilities, e);
      }

      ["load", "zoomend", "moveend"].forEach((event) => map.on(event, calculateInViewStats));
    </script>
  </body>
</html>
